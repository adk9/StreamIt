\section{Detailed Example}
This section describes the Trunked Radio example implementation in
detail. The code for the trunked radio demonstrate many features of
StreaMIT. 

The high-level structure of the radio, graphically shown in
Figure~\ref{fig:radiodiagram}, is implemented in the class {\tt
TrunkedRadio}.




\begin{figure}
\centering
\psfig{figure=fft-block.eps,width=3.2in}
\caption{ fig1}
\label{fig:data_structs}
\end{figure}

\begin{figure*}
\centering
\psfig{figure=fft-pre-tape.eps,width=4.8in}
\caption{ fig1}
\label{fig:data_structs}
\end{figure*}

\begin{figure*}
\centering
\psfig{figure=fft-butterfly-tape.eps,width=5.8in}
\caption{ fig1}
\label{fig:data_structs}
\end{figure*}

\begin{figure}
\centering
\psfig{figure=fir-block.eps,width=3.2in}
\caption{ fig1}
\label{fig:data_structs}
\end{figure}

\begin{figure*}
\centering
\psfig{figure=fir-tape.eps,width=5.2in}
\caption{ fig1}
\label{fig:data_structs}
\end{figure*}


\newpage

\begin{figure}[t]
\scriptsize
\begin{verbatim}
class Butterfly extends Stream {
   void init(int N, int W) {
      add(new SplitJoin() {
         void init() {
            weighted_round_robin(N, N);
            add (new Identity());
            add (new Filter() {
               Float weights[W];
               int curr;
               Channel input = new FloatChannel();
               Channel output = new FloatChannel();
               void init() {
                  for(int i=0; i<W; i++)
                     weights[i] = calc_weight(i, N, W);
                  curr = 0;
               }
               void work() {
                  output.push(input.pop()*weights[curr++]);
                  if(curr>= W) curr = 0;
               }    
            });
            round_robin();
      }});
      add(new SplitJoin() {
         void init() {
            duplicate();
            add (new Filter() {   
               Channel input = new FloatChannel();
               Channel output = new FloatChannel();
               void work() {
                  output.push(input.pop() + input.pop());
               }
            });
            add (new Filter() {   
               Channel input = new FloatChannel();
               Channel output = new FloatChannel();
               void work() {
                  output.push(input.pop() - input.pop());
               }
            });
            weighted_round_robin(N, N);
      }});
}}

class FFT extends Stream {
   void init(int N) {
      add(new SplitJoin() {
         void init() {
            weighted_round_robin(N/2, N/2);
            for(int i=0; i<2; i++) 
               add(new SplitJoin() {
                  void init() {
                     round_robin();
                     add (new Identity());
                     add (new Identity());
                     weighted_round_robin(N/4, N/4);
               }});
            round_robin();
      }});
      for(int i=2; i<=N/2; i *= 2)
        add(new Butterfly(i, N));
}}

class FIR extends Filter {
   Channel input = new FloatChannel();
   Channel output = new FloatChannel();           
   int N;

   void init(int N) {
      this.N = N;
   }

   void work() {
      Float sum = 0;
      for (int i=0; i<N; i++) {
         sum += input.peek(i)*fir_coeff[i][N];
      }
      input.pop();
      output.push(sum);
   }
}
\end{verbatim}
\vspace{-12pt}
\caption{\protect\small Example stuff.
\protect\label{fig1}}
\vspace{-12pt}
\end{figure}

\begin{figure}[t]
\scriptsize
\begin{verbatim}
class RFtoIF extends Filter {
   Channel input = new FloatChannel();
   Channel output = new FloatChannel();
   int sz, i;
   Float weight[];
   void init(Float f) {
      set_freq(f);
   }
   void work() {
      output.push(input.pop()*weight[i++]);
      if(i==sz) i = 0;
   }
   void set_freq(Float f) {
      i = 0;
      sz = CarrierFreq/f*N;
      weight = new Float[sz];
      for(int i=0; i<sz; i++)
         weight[i] = sine(i*pi/sz);
   }
}

class CheckFreqHop extends SplitJoin {
   FloatPortal freq_hop;
   void init(FloatPortal fh) {
      freq_hop = fh;
      weighted_round_robin(N/4-2,1,1,N/2,1,1,N/4-2);
      int k = 0;
      for(int i=0; i<4; i++) {
         if((i==0)||(i==2)) {
            for(int j=0; j<2; j++) {
               add(new Filter() {
                  Channel input = new FloatChannel();
                  Channel output = new FloatChannel();
                  void work() {
                     Float val = input.pop();
                     if(val >= MIN_TRASHOLD) 
                        freq_hop.set_freq(Freq[k], new TimeInterval(4*N, 6*N)); 
                     output.push(val);
                  }
               });
               k++;
            }
         } else
            add(new Identity());
      }
      weighted_round_robin(N/4-2,1,1,N/2,1,1,N/4-2);
   }
}

class CheckQuality extends Filter {
   Channel input = new FloatChannel();
   Channel output = new FloatChannel();
   Float ave_hi, ave_lo;   
   BoosterPortal on_off_switch;
   void init(BoosterPortal on_off) {
      ave_hi = 0;
      ave_lo = 0;
      on_off_switch = on_off;
   }
   void work() {
      Float val = input.pop();
      ave_hi = max(0.9*ave_hi, val);
      ave_lo = min(1.1*ave_lo, val);
      if(ave_hi - ave_lo < QUAL_BAD_TRASHOLD)
         on_off_switch.init(true);
      if(ave_hi - ave_lo > QUAL_GOOD_TRASHOLD)
         on_off_switch.init(false);
      output.push(val);
   }
}

class Booster extends Stream {
   void init(boolean adds) {
      if(adds) add(new FIR(N));
   }
}

class TrunkedRadio extends Stream {
   RFtoIFPortal freq_hop = new RFtoIFPortal();
   BoosterPortal onoff = new BoosterPortal().
   void init() {
      add(new ReadFromAtoD());

      RFtoIF RF2IF = new RFtoIF();
      add(RF2IF);
      freq_hop.register(RF2IF);

      Booster ISS = new Booster();
      add(ISS);
      onoff.register(ISS);
 
      add(new FFT());
      add(new CheckFreqHop(freq_hop));
      add(new CheckQuality(onoff));
      add(new AudioBackEnd());
   }
}

\end{verbatim}
\vspace{-12pt}
\caption{\protect\small Example stuff.
\protect\label{fig1}}
\vspace{-12pt}
\end{figure}
